<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile - Green Habit Tracker</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <nav class="navbar">
    <div class="logo">üå± Green Habit Tracker</div>
    <ul class="nav-links">
      <li><a href="tracker.html">Dashboard</a></li>
      <li><a href="dashboard.html">Progress</a></li>
      <li><a href="badges.html">Badges</a></li>
      <li><a href="profile.html" class="active">Profile</a></li>
      <li><a href="#" id="logout">Logout</a></li>
    </ul>
  </nav>

  <main class="profile-container">
    <div class="profile-card">
      <div class="profile-avatar" id="profileAvatar">
        <!-- User initials will be displayed here -->
      </div>
      
      <h1 class="profile-name" id="profileName">Loading...</h1>
      <p class="profile-email" id="profileEmail">Loading...</p>
      
      <div class="impact-summary">
        <h3>Total Impact Summary</h3>
        <div class="impact-item">
          <div class="impact-label">
            <span>üåø</span> CO‚ÇÇ Reduced:
          </div>
          <div class="impact-value" id="co2Value">0 kg</div>
        </div>
        <div class="impact-item">
          <div class="impact-label">
            <span>üíß</span> Water Saved:
          </div>
          <div class="impact-value" id="waterValue">0 L</div>
        </div>
        <div class="impact-item">
          <div class="impact-label">
            <span>‚ôªÔ∏è</span> Waste Diverted:
          </div>
          <div class="impact-value" id="wasteValue">0 kg</div>
        </div>
        <div class="impact-item">
          <div class="impact-label">
            <span>üî•</span> Current Streak:
          </div>
          <div class="impact-value" id="streakValue">0 days</div>
        </div>
      </div>

      <div class="profile-actions">
        <button class="btn-outline" onclick="editProfile()">Edit Profile</button>
        <button class="btn-primary" onclick="shareImpact()">Share Impact</button>
      </div>

      <div class="profile-actions">
        <button class="btn-danger" onclick="deleteAccount()">Delete Account</button>
      </div>
    </div>
  </main>

  <script type="module">
    import { auth, db } from './firebase-config.js';
    import {
      onAuthStateChanged,
      signOut,
      deleteUser
    } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
    import {
      doc,
      getDoc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

    // Same habits as tracker.js for calculation
    const habits = [
      { id: "publicTransport", unit: "CO‚ÇÇ", value: 1.5 },
      { id: "reusableBottle", unit: "plastic", value: 0.2 },
      { id: "recycledWaste", unit: "waste", value: 0.5 },
      { id: "walked", unit: "CO‚ÇÇ", value: 2.1 },
      { id: "ledLights", unit: "CO‚ÇÇ", value: 0.8 },
      { id: "plantMeal", unit: "CO‚ÇÇ", value: 1.2 },
      { id: "noPlastic", unit: "plastic", value: 0.3 },
      { id: "savedWater", unit: "water", value: 15 },
      { id: "bike", unit: "CO‚ÇÇ", value: 3.2 },
      { id: "compost", unit: "waste", value: 0.7 },
      { id: "renewable", unit: "CO‚ÇÇ", value: 2.5 },
      { id: "localProduce", unit: "CO‚ÇÇ", value: 0.9 }
    ];

    function calculateStreak(logs) {
      const today = new Date();
      let streak = 0;
      
      for (let i = 0; i < 365; i++) {
        const checkDate = new Date(today);
        checkDate.setDate(today.getDate() - i);
        const dateStr = checkDate.toISOString().split('T')[0];
        
        if (logs[dateStr]) {
          const dayEntries = logs[dateStr];
          let hasAnyHabit = false;
          
          if (Array.isArray(dayEntries)) {
            // New format - array of submissions
            for (const entry of dayEntries) {
              const habitEntries = entry.habits;
              if (Object.values(habitEntries).some(habit => habit === true)) {
                hasAnyHabit = true;
                break;
              }
            }
          } else {
            // Old format - direct habit mapping
            hasAnyHabit = Object.values(dayEntries).some(habit => habit === true);
          }
          
          if (hasAnyHabit) {
            streak++;
          } else {
            break;
          }
        } else {
          break;
        }
      }
      
      return streak;
    }

    async function loadUserProfile(user) {
      try {
        // Load user data
        const userDocRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userDocRef);
        
        // Load habit data
        const habitDocRef = doc(db, "habits", user.uid);
        const habitSnap = await getDoc(habitDocRef);
        
        // Display user info
        document.getElementById('profileName').textContent = user.displayName || user.email.split('@')[0];
        document.getElementById('profileEmail').textContent = user.email;
        
        // Create avatar with initials
        const name = user.displayName || user.email;
        const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        document.getElementById('profileAvatar').textContent = initials;
        
        // Calculate total impact
        let totalCO2 = 0;
        let totalWater = 0;
        let totalWaste = 0;
        let currentStreak = 0;
        
        if (habitSnap.exists()) {
          const habitData = habitSnap.data();
          currentStreak = calculateStreak(habitData);
          
          // Calculate totals
          Object.entries(habitData).forEach(([date, dayData]) => {
            if (typeof dayData === 'object') {
              if (Array.isArray(dayData)) {
                // New format - array of submissions
                dayData.forEach(entry => {
                  const habitEntries = entry.habits;
                  habits.forEach(habit => {
                    if (habitEntries[habit.id]) {
                      switch (habit.unit) {
                        case 'CO‚ÇÇ':
                          totalCO2 += habit.value;
                          break;
                        case 'water':
                          totalWater += habit.value;
                          break;
                        case 'waste':
                          totalWaste += habit.value;
                          break;
                        case 'plastic':
                          totalWaste += habit.value;
                          break;
                      }
                    }
                  });
                });
              } else {
                // Old format - direct habit mapping
                habits.forEach(habit => {
                  if (dayData[habit.id]) {
                    switch (habit.unit) {
                      case 'CO‚ÇÇ':
                        totalCO2 += habit.value;
                        break;
                      case 'water':
                        totalWater += habit.value;
                        break;
                      case 'waste':
                        totalWaste += habit.value;
                        break;
                      case 'plastic':
                        totalWaste += habit.value;
                        break;
                    }
                  }
                });
              }
            }
          });
          
          console.log('Calculated totals:', { totalCO2, totalWater, totalWaste, currentStreak });
        }
        
        // Update display
        document.getElementById('co2Value').textContent = `${totalCO2.toFixed(1)} kg`;
        document.getElementById('waterValue').textContent = `${totalWater} L`;
        document.getElementById('wasteValue').textContent = `${totalWaste.toFixed(1)} kg`;
        document.getElementById('streakValue').textContent = `${currentStreak} days`;
        
      } catch (error) {
        console.error('Error loading profile:', error);
        
        // Provide user-friendly error messages based on error code
        let errorMessage = "An error occurred while loading your profile data. Please try again.";
        
        if (error.code && error.code.startsWith('firestore/')) {
          switch(error.code) {
            case 'firestore/permission-denied':
              errorMessage = "You don't have permission to access this data. Please log out and log back in.";
              break;
            case 'firestore/unavailable':
              errorMessage = "The service is currently unavailable. Please try again later.";
              break;
            case 'firestore/not-found':
              errorMessage = "Your profile data could not be found. Please contact support.";
              break;
            case 'firestore/network-request-failed':
              errorMessage = "Network error. Please check your internet connection and try again.";
              break;
          }
        }
        
        alert(errorMessage);
      }
    }

    // Edit profile function
    window.editProfile = function() {
      const newName = prompt('Enter new display name:', auth.currentUser.displayName);
      if (newName && newName.trim()) {
        import("https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js")
          .then(({ updateProfile }) => {
            return updateProfile(auth.currentUser, { displayName: newName.trim() });
          })
          .then(() => {
            alert('Profile updated successfully!');
            location.reload();
          })
          .catch(error => {
            console.error(error);
            
            // Provide user-friendly error messages based on error code
            let errorMessage = "An error occurred while updating your profile. Please try again.";
            
            switch(error.code) {
              case 'auth/requires-recent-login':
                errorMessage = "For security reasons, please log out and log back in before updating your profile.";
                break;
              case 'auth/network-request-failed':
                errorMessage = "Network error. Please check your internet connection and try again.";
                break;
            }
            
            alert(errorMessage);
          });
      }
    };

    // Share impact function
    window.shareImpact = function() {
      const co2 = document.getElementById('co2Value').textContent;
      const water = document.getElementById('waterValue').textContent;
      const waste = document.getElementById('wasteValue').textContent;
      const streak = document.getElementById('streakValue').textContent;
      
      // Format the impact data for sharing
      const shareText = `üå± My Green Impact with Green Habit Tracker:\n\n` +
                       `üåø CO‚ÇÇ Reduced: ${co2}\n` +
                       `üíß Water Saved: ${water}\n` +
                       `‚ôªÔ∏è Waste Diverted: ${waste}\n` +
                       `üî• Current Streak: ${streak}\n\n` +
                       `Small habits, big impact! üåç #GreenHabitTracker`;
      
      // Create a modal for social sharing options
      const modal = document.createElement('div');
      modal.className = 'share-modal';
      modal.innerHTML = `
        <div class="share-modal-content">
          <h3>Share Your Impact</h3>
          <div class="social-buttons">
            <button class="social-btn whatsapp"><i class="fab fa-whatsapp fa-lg"></i> WhatsApp</button>
            <button class="social-btn instagram"><i class="fab fa-instagram fa-lg"></i> Instagram</button>
            <button class="social-btn facebook"><i class="fab fa-facebook-f fa-lg"></i> Facebook</button>
            <button class="social-btn twitter"><i class="fab fa-twitter fa-lg"></i> Twitter</button>
            <button class="social-btn email"><i class="fas fa-envelope fa-lg"></i> Email</button>
          </div>
          <button class="close-modal">Close</button>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Add Font Awesome for icons
      if (!document.querySelector('link[href*="font-awesome"]')) {
        const fontAwesome = document.createElement('link');
        fontAwesome.rel = 'stylesheet';
        fontAwesome.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css';
        document.head.appendChild(fontAwesome);
      }
      
      // Ensure Font Awesome is loaded before showing icons
      setTimeout(() => {
        document.querySelectorAll('.social-btn i').forEach(icon => {
          icon.style.marginRight = '8px';
        });
      }, 100);
      
      // Add styles for the modal
      const style = document.createElement('style');
      style.textContent = `
        .share-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
        }
        .share-modal-content {
          background-color: white;
          padding: 20px;
          border-radius: 10px;
          max-width: 500px;
          width: 90%;
          text-align: center;
        }
        .social-buttons {
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          gap: 10px;
          margin: 20px 0;
        }
        .social-btn {
          padding: 12px 20px;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
          font-weight: bold;
          transition: all 0.3s ease;
          font-size: 16px;
          min-width: 140px;
        }
        .social-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .social-btn i {
          font-size: 20px;
          width: 24px;
          text-align: center;
        }
        .whatsapp { background-color: #25D366; color: white; }
        .instagram { background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); color: white; }
        .facebook { background-color: #3b5998; color: white; }
        .twitter { background-color: #1DA1F2; color: white; }
        .email { background-color: #D44638; color: white; }
        .close-modal {
          background-color: #f1f1f1;
          border: none;
          padding: 10px 20px;
          border-radius: 5px;
          cursor: pointer;
          margin-top: 10px;
        }
      `;
      document.head.appendChild(style);
      
      // Handle social media sharing
      const whatsappBtn = modal.querySelector('.whatsapp');
      const instagramBtn = modal.querySelector('.instagram');
      const facebookBtn = modal.querySelector('.facebook');
      const twitterBtn = modal.querySelector('.twitter');
      const emailBtn = modal.querySelector('.email');
      const closeBtn = modal.querySelector('.close-modal');
      
      whatsappBtn.addEventListener('click', () => {
        window.open(`https://wa.me/?text=${encodeURIComponent(shareText)}`, '_blank');
      });
      
      instagramBtn.addEventListener('click', () => {
        // Instagram doesn't have a direct sharing API, so copy to clipboard
        navigator.clipboard.writeText(shareText).then(() => {
          alert('Impact summary copied to clipboard! Open Instagram and paste in your story or post.');
        });
      });
      
      facebookBtn.addEventListener('click', () => {
        window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${encodeURIComponent(shareText)}`, '_blank');
      });
      
      twitterBtn.addEventListener('click', () => {
        window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`, '_blank');
      });
      
      emailBtn.addEventListener('click', () => {
        window.open(`mailto:?subject=My Green Impact&body=${encodeURIComponent(shareText)}`, '_blank');
      });
      
      closeBtn.addEventListener('click', () => {
        document.body.removeChild(modal);
        document.head.removeChild(style);
      });
      
      // Fallback to native sharing if available
      if (navigator.share) {
        const nativeShareBtn = document.createElement('button');
        nativeShareBtn.className = 'social-btn native-share';
        nativeShareBtn.innerHTML = '<i class="fas fa-share-alt fa-lg"></i> Use Device Sharing';
        nativeShareBtn.style.backgroundColor = '#6200ea';
        nativeShareBtn.style.color = 'white';
        nativeShareBtn.style.marginTop = '10px';
        nativeShareBtn.style.width = '100%';
        nativeShareBtn.style.maxWidth = '300px';
        
        modal.querySelector('.social-buttons').appendChild(nativeShareBtn);
        
        nativeShareBtn.addEventListener('click', () => {
          navigator.share({
            title: 'My Green Impact',
            text: shareText
          }).then(() => {
            document.body.removeChild(modal);
            document.head.removeChild(style);
          }).catch(console.error);
        });
      }
    };


    // Delete account function
    window.deleteAccount = function() {
      if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
        const user = auth.currentUser;
        
        // Delete user documents
        Promise.all([
          deleteDoc(doc(db, "users", user.uid)).catch(() => {}),
          deleteDoc(doc(db, "habits", user.uid)).catch(() => {})
        ]).then(() => {
          // Delete user account
          return deleteUser(user);
        }).then(() => {
          alert('Account deleted successfully');
          window.location.href = 'index.html';
        }).catch(error => {
          console.error(error);
          
          // Provide user-friendly error messages based on error code
          let errorMessage = "An error occurred while deleting your account. Please try again.";
          
          switch(error.code) {
            case 'auth/requires-recent-login':
              errorMessage = "For security reasons, please log out and log back in before deleting your account.";
              break;
            case 'auth/network-request-failed':
              errorMessage = "Network error. Please check your internet connection and try again.";
              break;
          }
          
          alert(errorMessage);
        });
      }
    };

    // Logout function
    document.getElementById('logout').addEventListener('click', () => {
      // Set a flag in sessionStorage to indicate intentional logout
      sessionStorage.setItem('intentionalLogout', 'true');
      signOut(auth).then(() => {
        window.location.href = 'index.html';
      });
    });

    // Auth state observer
    onAuthStateChanged(auth, user => {
      if (user) {
        loadUserProfile(user);
      } else {
        window.location.href = 'index.html';
      }
    });
  </script>
</body>
</html>